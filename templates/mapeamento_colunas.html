{# =============================================================================
   Template: mapeamento_colunas.html
   Vers√£o: v0.3.1 - 2025-08-11
   CHANGELOG:
     - [+] Campos adicionados ao mapeamento: "descricao_produto", "serial" e "cod_pro".
     - [=] Mantido fluxo em 3 etapas (Preview ‚Üí Pr√©-importar ‚Üí Importar).
     - [=] Bot√£o "Importar agora" segue desabilitado at√© a pr√©-importa√ß√£o.
   DEPEND√äNCIAS:
     - Contexto precisa conter: headers (lista de strings com os cabe√ßalhos do CSV)
   ============================================================================= #}

{% extends "base.html" %}
{% block title %}Mapeamento de Colunas - Importa√ß√£o{% endblock %}

{% block content %}
<h3>üß≠ Mapeamento de Colunas (Preview / Pr√©-importa√ß√£o / Importar)</h3>
<p class="text-muted mb-3">
  Associe os campos can√¥nicos √†s colunas do seu CSV. Dica: mapeie <strong>Ativo</strong> e <strong>cod_cli</strong>
  quando dispon√≠veis (usados na checagem de duplicidade). Para itens, d√™ prefer√™ncia a <strong>Descri√ß√£o do produto</strong>
  quando existir no arquivo.
</p>

<div class="mb-2">
  <strong>Cabe√ßalhos detectados:</strong>
  <div class="small font-monospace border rounded p-2" style="white-space:pre-wrap;">
    {{ headers|join(", ") }}
  </div>
</div>

<form id="form-mov" class="mt-3" enctype="multipart/form-data" method="post">
  <div class="mb-3">
    <label for="csvfile" class="form-label">Arquivo CSV</label>
    <input type="file" id="csvfile" name="file" accept=".csv" required class="form-control">
    <div class="form-text">Reenvie o arquivo ao fazer <em>Preview</em> ou <em>Pr√©-importar</em>.</div>
  </div>

  <div class="row g-3">
    {% set campos = [
      ("contrato", "N¬∫ do contrato (obrigat√≥rio)"),
      ("item", "Item / c√≥digo (obrigat√≥rio)"),
      ("descricao_produto", "Descri√ß√£o do produto (preferencial)"),
      ("serial", "Serial (opcional)"),
      ("cod_pro", "C√≥digo do produto (opcional)"),
      ("data_mov", "Data do movimento (obrigat√≥rio)"),
      ("tipo", "Tipo do movimento"),
      ("qtd", "Quantidade"),
      ("valor_mensal", "Valor mensal"),
      ("meses_restantes", "Meses restantes"),
      ("cliente", "Cliente"),
      ("observacao", "Observa√ß√£o"),
      ("ativo", "Ativo (opcional ‚Äî recomendado)"),
      ("cod_cli", "C√≥digo do Cliente (cod_cli) (opcional ‚Äî recomendado)")
    ] %}

    {% for key, rotulo in campos %}
    <div class="col-md-6">
      <label class="form-label">{{ rotulo }}</label>
      <select class="form-select map-select" data-canon="{{ key }}">
        <option value="">‚Äî n√£o mapear ‚Äî</option>
        {% for h in headers %}
          <option value="{{ h }}">{{ h }}</option>
        {% endfor %}
      </select>
    </div>
    {% endfor %}
  </div>

  <input type="hidden" name="mapping" id="mapping-json">

  <div class="row g-3 mt-2">
    <div class="col-md-3">
      <label class="form-label">Delimitador</label>
      <select name="delimiter" class="form-select">
        <option value="auto" selected>Auto</option>
        <option value=";">;</option>
        <option value=",">,</option>
        <option value="|">|</option>
        <option value="\\t">TAB</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Encoding</label>
      <select name="encoding" class="form-select">
        <option value="utf-8-sig" selected>utf-8-sig</option>
        <option value="latin1">latin1</option>
        <option value="utf-8">utf-8</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Amostra de linhas</label>
      <input type="number" class="form-control" name="sample_rows" value="5" min="1" max="50">
    </div>
    <div class="col-md-3">
      <label class="form-label">Limite de linhas</label>
      <input type="number" class="form-control" name="max_rows" value="200000" min="1000" max="1000000">
    </div>
  </div>

  <div class="mt-3 d-flex gap-2">
    <button id="btn-preview"   type="button" class="btn btn-outline-secondary">Gerar preview</button>
    <button id="btn-preimport" type="button" class="btn btn-warning">Pr√©-importar (salvar lote)</button>
    <button id="btn-commit"    type="button" class="btn btn-primary" disabled>Importar agora</button>
    <a href="/dashboard" class="btn btn-light">Voltar</a>
  </div>
</form>

<hr>

<div class="d-flex align-items-center gap-2 mb-2">
  <strong>Status do lote:</strong>
  <span id="lote-id" class="badge bg-secondary">‚Äî</span>
</div>

<h4 class="mt-1">Resultado</h4>
<pre id="resultado" class="border rounded p-3" style="max-height:420px; overflow:auto; background:#f8f9fa;">‚Äî gere o preview ou fa√ßa a pr√©-importa√ß√£o ‚Äî</pre>

<script>
(function(){
  const form = document.getElementById('form-mov');
  const res  = document.getElementById('resultado');
  const mapInput = document.getElementById('mapping-json');
  const btnPreview   = document.getElementById('btn-preview');
  const btnPreimport = document.getElementById('btn-preimport');
  const btnCommit    = document.getElementById('btn-commit');
  const loteBadge    = document.getElementById('lote-id');

  function buildFormData() {
    // Monta JSON de mapeamento { canon: "cabe√ßalho" }
    const mapping = {};
    document.querySelectorAll('.map-select').forEach(s=>{
      const canon = s.getAttribute('data-canon');
      const val = (s.value || '').trim();
      if (val) mapping[canon] = val;
    });
    mapInput.value = JSON.stringify(mapping);
    return new FormData(form);
  }

  async function post(url, fd) {
    const r = await fetch(url, { method: 'POST', body: fd });
    const t = await r.text();
    try { return JSON.parse(t); } catch { return t; }
  }

  btnPreview.addEventListener('click', async () => {
    res.textContent = 'Processando preview...';
    const out = await post('/importar_movimentacao/preview', buildFormData());
    res.textContent = (typeof out === 'string') ? out : JSON.stringify(out, null, 2);
  });

  btnPreimport.addEventListener('click', async () => {
    res.textContent = 'Salvando lote (pr√©-importa√ß√£o)...';
    const out = await post('/importar_movimentacao/preimport', buildFormData());
    res.textContent = (typeof out === 'string') ? out : JSON.stringify(out, null, 2);
    if (out && out.ok) {
      btnCommit.removeAttribute('disabled');
      if (out.lote_id) loteBadge.textContent = out.lote_id;
      loteBadge.className = 'badge bg-success';
    } else {
      btnCommit.setAttribute('disabled','disabled');
      loteBadge.textContent = '‚Äî';
      loteBadge.className = 'badge bg-secondary';
    }
  });

  btnCommit.addEventListener('click', async () => {
    res.textContent = 'Executando importa√ß√£o (commit)...';
    const r = await fetch('/importar_movimentacao/commit', { method: 'POST' });
    const t = await r.text();
    try {
      const out = JSON.parse(t);
      res.textContent = JSON.stringify(out, null, 2);
      if (out && out.ok) {
        // terminou; desabilita at√© novo pr√©-import
        btnCommit.setAttribute('disabled','disabled');
        loteBadge.textContent = '‚Äî';
        loteBadge.className = 'badge bg-secondary';
      }
    } catch {
      res.textContent = t;
    }
  });
})();
</script>
{% endblock %}
