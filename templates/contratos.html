{# contratos.html ‚Äî v2025.08.26.3
   Altera√ß√µes:
   - Cabe√ßalho da tabela com roxo do tema (em vez de preto).
   - Listras do corpo em roxo clarinho/branco (sem fundo preto).
   - Mantidas: filtros, export, ordena√ß√£o, pagina√ß√£o, badges/resumos, backlog, sticky header.
#}
{% extends "base.html" %}
{% block title %}Lista de Contratos{% endblock %}

{% block content %}

{# ===== Macros de formata√ß√£o seguras (mantidas) ===== #}
{% macro money(v) -%}
  R$ {{ "{:,.2f}".format((v or 0.0)) }}
{%- endmacro %}
{% macro datebr(d) -%}
  {{ d.strftime('%d/%m/%Y') if d else '' }}
{%- endmacro %}

<style>
  :root{
    --wb-brand: #5b2aa6;            /* roxo do topo/menu (mais escuro) */
    --wb-row-alt: #f3e8ff;          /* roxo clarinho das listras */
    --wb-row-hover: #ede9fe;        /* hover suave */
    --wb-badge-bg: #ede9fe;         /* badges */
    --wb-badge-fg: #3730a3;
  }

  /* rolagem fluida (evita ‚Äútela travada‚Äù) */
  html, body { overflow-y: auto !important; }

  /* cabe√ßalho fixo e largura est√°vel da tabela */
  .table-responsive { overflow-x: auto; }
  table.table { table-layout: fixed; }
  thead.wb-thead th { position: sticky; top: 0; z-index: 2; background: var(--wb-brand); color: #fff; }
  thead.wb-thead th a { color: #fff; }

  /* larguras por coluna (mantidas) */
  th.col-id{width:64px}
  th.col-ativo{width:120px}
  th.col-serial{width:140px}
  th.col-codprod{width:130px}
  th.col-desc{width:240px}
  th.col-codcli{width:120px}
  th.col-nomecli{width:220px}
  th.col-data{width:120px}
  th.col-contrato{width:140px}
  th.col-monet{width:130px}
  th.col-int{width:120px}
  th.col-acao{width:120px}
  td.ellipsis, th.ellipsis { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

  /* Paleta da tabela (substitui listras padr√£o) */
  table.table.wb {
    --bs-table-striped-bg: var(--wb-row-alt);
    --bs-table-striped-color: inherit;
    --bs-table-hover-bg: var(--wb-row-hover);
    --bs-table-hover-color: inherit;
    --bs-table-bg: #ffffff;
  }

  /* barra de filtros/a√ß√µes */
  .filters .form-control{ height:38px }
  .badge-soft {
    display:inline-block; padding:.35rem .6rem; border-radius:999px;
    background:var(--wb-badge-bg); color:var(--wb-badge-fg); font-weight:600; font-size:.85rem;
  }
</style>

<div class="d-flex justify-content-between align-items-end gap-2 flex-wrap mb-3">
  <!-- Filtros -->
  <form class="filters d-flex align-items-end gap-2 flex-wrap" method="get" action="/contratos">
    <div>
      <label class="form-label mb-1">Cliente (cont√©m)</label>
      <input type="text" name="cliente" value="{{ cliente or '' }}" class="form-control" placeholder="Ex.: ACME">
    </div>
    <div>
      <label class="form-label mb-1">Contrato N¬∫</label>
      <input type="text" name="contrato" value="{{ contrato or '' }}" class="form-control" placeholder="Ex.: 2023-001">
    </div>
    <div>
      <label class="form-label mb-1">Ativo</label>
      <input type="text" name="ativo" value="{{ ativo or '' }}" class="form-control" placeholder="Ex.: NB-1234">
    </div>
    <div class="form-check mb-2 ms-2">
      <input class="form-check-input" type="checkbox" id="chkRet" name="incluir_retornados" value="true" {% if incluir_retornados %}checked{% endif %}>
      <label class="form-check-label" for="chkRet">Incluir retornados</label>
    </div>

    <input type="hidden" name="order_by" value="{{ order_by }}">
    <input type="hidden" name="order_dir" value="{{ order_dir }}">
    <input type="hidden" name="per_page" value="{{ per_page }}">
    <input type="hidden" name="page" value="1">

    <button type="submit" class="btn btn-primary">Aplicar</button>
    <a href="/contratos" class="btn btn-outline-secondary">Limpar</a>
  </form>

  <!-- A√ß√µes (export e atualizar tudo) -->
  {% set qs_base = 'cliente=' ~ (cliente|urlencode) ~
                   '&contrato=' ~ (contrato|urlencode) ~
                   '&ativo=' ~ (ativo|urlencode) ~
                   '&incluir_retornados=' ~ ('true' if incluir_retornados else 'false') ~
                   '&order_by=' ~ (order_by or '') ~
                   '&order_dir=' ~ (order_dir or '') %}

  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" target="_blank" href="/contratos/export?fmt=csv&{{ qs_base }}">Exportar CSV</a>
    <a class="btn btn-outline-secondary" target="_blank" href="/contratos/export?fmt=xlsx&{{ qs_base }}">Exportar XLSX</a>

    <form action="/contratos/sincronizar" method="post"
          onsubmit="return confirm('Atualizar todos os contratos? Esta opera√ß√£o pode levar alguns segundos.');">
      <button type="submit" class="btn btn-primary">Atualizar tudo</button>
    </form>
  </div>
</div>

{# alertas do modo "lote" (mantidos) #}
{% if request.query_params.get('ok') == '1' %}
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    Atualiza√ß√£o em lote conclu√≠da ‚Äî atualizados: {{ request.query_params.get('n','0') }},
    sem cabe√ßalho: {{ request.query_params.get('skip_sem_cab','0') }}, retornados ignorados: {{ request.query_params.get('skip_ret','0') }},
    erros: {{ request.query_params.get('err','0') }}.
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
{% elif request.query_params.get('msg') == 'sem_itens' %}
  <div class="alert alert-warning alert-dismissible fade show" role="alert">
    Nenhum item encontrado para este contrato.
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
{% endif %}

{% if usando_retornados %}
  <div class="alert alert-warning py-2">
    Nenhum item ‚Äúem carteira‚Äù. Mostrando com <strong>retornados inclu√≠dos</strong>.
  </div>
{% endif %}

<h2 class="mb-2">üìÑ Lista de Contratos</h2>

<div class="mb-2 d-flex gap-2 flex-wrap">
  <span class="badge-soft">Total: {{ total }}</span>
  <span class="badge-soft">Valor Mensal: {{ money(valor_mensal_sum) }}</span>
  <span class="badge-soft">Backlog: {{ money(backlog_sum) }}</span>
</div>

{# ==== Cabe√ßalho com ordena√ß√£o ==== #}
{% set flip = 'asc' if (order_dir == 'desc') else 'desc' %}
{% macro head(label, col, klass) -%}
  {% set dir = flip if (order_by == col) else 'desc' %}
  <th class="{{ klass }} ellipsis">
    <a class="link-light text-decoration-none"
       href="/contratos?{{ qs_base }}&per_page={{ per_page }}&page=1&order_by={{ col }}&order_dir={{ dir }}">
      {{ label }}{% if order_by == col %} {{ '‚ñ≤' if order_dir=='asc' else '‚ñº' }}{% endif %}
    </a>
  </th>
{%- endmacro %}

<div class="table-responsive mt-3">
  <table class="table table-bordered table-hover table-sm table-striped wb align-middle">
    <thead class="wb-thead">
      <tr>
        {{ head('ID','id','col-id') }}
        {{ head('Ativo','ativo','col-ativo') }}
        {{ head('Serial','serial','col-serial') }}
        {{ head('C√≥digo Produto','cod_pro','col-codprod') }}
        {{ head('Descri√ß√£o','descricao_produto','col-desc') }}
        {{ head('C√≥d. Cliente','cod_cli','col-codcli') }}
        {{ head('Nome Cliente','nome_cli','col-nomecli') }}
        {{ head('Data Envio','data_envio','col-data') }}
        {{ head('Contrato N¬∫','contrato_num','col-contrato') }}
        {{ head('Valor Mensal','valor_mensal','col-monet') }}
        {{ head('Per√≠odo Contratual','periodo_contratual','col-int') }}
        {{ head('Meses Restantes','meses_restantes','col-int') }}
        {{ head('Valor Global','valor_global_contrato','col-monet') }}
        {{ head('BackLog','backlog','col-monet') }}
        <th class="col-acao text-center">A√ß√µes</th>
      </tr>
    </thead>
    <tbody>
      {# usa a chave que seu back-end antigo j√° esperava #}
      {% set lista = contratos if contratos is defined else rows %}
      {% for c in lista %}
        {% set contrato_num = c.contrato_num or c.contrato_n or c.numero or c.numero_contrato %}
        {% set vm = (c.valor_mensal or 0.0) %}
        {% set mr = (c.meses_restantes or 0) %}
        {% set backlog = (vm * mr) %}
        <tr>
          <td class="ellipsis text-center" title="{{ c.id }}">{{ c.id }}</td>
          <td class="ellipsis" title="{{ c.ativo }}">{{ c.ativo }}</td>
          <td class="ellipsis" title="{{ c.serial }}">{{ c.serial or '' }}</td>
          <td class="ellipsis" title="{{ c.cod_pro }}">{{ c.cod_pro or '' }}</td>
          <td class="ellipsis" title="{{ c.descricao_produto }}">{{ c.descricao_produto or '' }}</td>
          <td class="ellipsis text-center" title="{{ c.cod_cli }}">{{ c.cod_cli or '' }}</td>
          <td class="ellipsis" title="{{ c.nome_cli }}">{{ c.nome_cli or '' }}</td>
          <td class="ellipsis text-center" title="{{ c.data_envio }}">{{ datebr(c.data_envio) }}</td>
          <td class="ellipsis text-center" title="{{ contrato_num }}">{{ contrato_num or '' }}</td>
          <td class="ellipsis text-end" title="{{ vm }}">{{ money(vm) }}</td>
          <td class="ellipsis text-center" title="{{ c.periodo_contratual }}">{{ c.periodo_contratual or '' }}</td>
          <td class="ellipsis text-center" title="{{ mr }}">{{ mr }}</td>
          <td class="ellipsis text-end" title="{{ c.valor_global_contrato }}">{{ money(c.valor_global_contrato or 0) }}</td>
          <td class="ellipsis text-end" title="{{ backlog }}">{{ money(backlog) }}</td>
          <td class="text-center">
            {% if contrato_num %}
              <form action="/contratos/sincronizar/{{ contrato_num }}" method="post" class="d-inline"
                    onsubmit="return confirm('Sincronizar e recalcular o contrato {{ contrato_num }}?');">
                <button type="submit" class="btn btn-sm btn-outline-primary">Atualizar</button>
              </form>
            {% else %}
              <button type="button" class="btn btn-sm btn-outline-secondary" disabled
                      title="Este item n√£o possui n√∫mero de contrato dispon√≠vel">
                Atualizar
              </button>
            {% endif %}
          </td>
        </tr>
      {% else %}
        <tr><td colspan="15" class="text-center py-3">Nenhum registro encontrado.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{# ===== Pagina√ß√£o ===== #}
{% set total_pages = (total // per_page) + (1 if (total % per_page) else 0) %}
{% set base = '/contratos?' ~ qs_base ~ '&order_by=' ~ (order_by or '') ~ '&order_dir=' ~ (order_dir or '') %}
<div class="d-flex justify-content-between align-items-center mt-2 flex-wrap gap-2">
  <div class="btn-group" role="group" aria-label="Pagina√ß√£o">
    <a class="btn btn-outline-secondary" href="{{ base }}&per_page={{ per_page }}&page=1">¬´ Primeiro</a>
    <a class="btn btn-outline-secondary" href="{{ base }}&per_page={{ per_page }}&page={{ page-1 if page>1 else 1 }}">‚Äπ Anterior</a>
    <span class="btn btn-outline-secondary disabled">P√°gina {{ page }} / {{ total_pages if total_pages>0 else 1 }}</span>
    <a class="btn btn-outline-secondary" href="{{ base }}&per_page={{ per_page }}&page={{ page+1 if page<total_pages else total_pages }}">Pr√≥ximo ‚Ä∫</a>
    <a class="btn btn-outline-secondary" href="{{ base }}&per_page={{ per_page }}&page={{ total_pages if total_pages>0 else 1 }}">√öltimo ¬ª</a>
  </div>
  <div class="btn-group" role="group" aria-label="Itens por p√°gina">
    <span class="btn btn-outline-secondary disabled">Itens por p√°gina</span>
    {% for n in [25,50,100,200] %}
      <a class="btn {% if per_page==n %}btn-primary{% else %}btn-outline-secondary{% endif %}"
         href="{{ base }}&per_page={{ n }}&page=1">{{ n }}</a>
    {% endfor %}
  </div>
</div>

{% endblock %}
