{#
  =======================================================================================
  Projeto: Sistema de GestÃ£o de Contratos
  Arquivo: templates/dashboard.html
  VersÃ£o: v2.4 - 2025-08-25
  AlteraÃ§Ãµes (v2.4):
    â€¢ Removido o card "Valor Global Total" do template (nÃ£o exibimos mais).
    â€¢ Mantidos todos os cÃ¡lculos no backend; nenhuma dependÃªncia visual do valor global.
    â€¢ Limpeza: removida variÃ¡vel JS nÃ£o utilizada referente ao valor global.
  Base anterior: v2.3 - 2025-08-25 (com fallbacks de endpoints e KPIs novos)
  =======================================================================================
#}

{% extends "base.html" %}
{% block title %}Dashboard de Contratos{% endblock %}

{% block content %}
<h2 class="d-flex align-items-center gap-3">
  <span>ðŸ“Š VisÃ£o Geral dos Contratos</span>
  <small id="chips-filtros" class="d-inline-flex flex-wrap gap-2"></small>
</h2>

<form id="form-filtros" class="row g-2 align-items-end mt-1 mb-3 position-relative">
  <div class="col-12 col-md-4">
    <label for="f-cliente" class="form-label">Cliente (contÃ©m)</label>
    <input type="text" id="f-cliente" class="form-control" placeholder="Ex.: ACME" autocomplete="off">
    <div id="sugestoes" class="list-group shadow position-absolute w-100"
         style="z-index:1050; display:none; max-height:260px; overflow:auto;"></div>
  </div>
  <div class="col-6 col-md-3">
    <label for="f-de" class="form-label">De</label>
    <input type="date" id="f-de" class="form-control">
  </div>
  <div class="col-6 col-md-3">
    <label for="f-ate" class="form-label">AtÃ©</label>
    <input type="date" id="f-ate" class="form-control">
  </div>
  <div class="col-12 col-md-2 d-grid">
    <button type="submit" class="btn btn-primary">Aplicar</button>
  </div>
</form>

<div id="resumo"></div>

<!-- KPIs principais (3 cards: Total, Valor Mensal, Backlog) -->
<div class="row mt-3">
  <div class="col-md-4">
    <div class="card text-bg-primary mb-3">
      <div class="card-body">
        <h5 class="card-title">Total de Contratos</h5>
        <p class="card-text fs-4 fw-bold" id="totalContratos">...</p>
        <div class="small">
          <span class="badge bg-light text-dark me-1">com itens: <span id="totalContratosComItens">â€”</span></span>
          <span class="badge bg-light text-dark">itens: <span id="totalItensContrato">â€”</span></span>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card text-bg-success mb-3">
      <div class="card-body">
        <h5 class="card-title">Valor Mensal Total</h5>
        <p class="card-text fs-4 fw-bold"><span id="valorMensal">...</span></p>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card text-bg-info mb-3">
      <div class="card-body">
        <h5 class="card-title">Backlog Total</h5>
        <p class="card-text fs-4 fw-bold"><span id="valorBacklog">...</span></p>
      </div>
    </div>
  </div>
</div>

<!-- KPIs adicionais: mÃªs atual e vencidos -->
<div class="row">
  <div class="col-md-4">
    <div class="card border-0 shadow-sm mb-3">
      <div class="card-body">
        <h6 class="card-title mb-2">Itens devolvidos no mÃªs</h6>
        <div class="d-flex align-items-center gap-4">
          <div>
            <div class="text-muted" style="font-size:.85rem">Quantidade</div>
            <div class="fs-4 fw-semibold" id="retMesQtd">â€”</div>
          </div>
          <div>
            <div class="text-muted" style="font-size:.85rem">Valor mensal</div>
            <div class="fs-4 fw-semibold" id="retMesValor">â€”</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card border-0 shadow-sm mb-3">
      <div class="card-body">
        <h6 class="card-title mb-2">Itens entregues no mÃªs</h6>
        <div class="d-flex align-items-center gap-4">
          <div>
            <div class="text-muted" style="font-size:.85rem">Quantidade</div>
            <div class="fs-4 fw-semibold" id="envMesQtd">â€”</div>
          </div>
          <div>
            <div class="text-muted" style="font-size:.85rem">Valor mensal</div>
            <div class="fs-4 fw-semibold" id="envMesValor">â€”</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card border-0 shadow-sm mb-3">
      <div class="card-body">
        <h6 class="card-title mb-2">Contratos vencidos</h6>
        <div class="d-flex align-items-center gap-4">
          <div>
            <div class="text-muted" style="font-size:.85rem">Quantidade</div>
            <div class="fs-4 fw-semibold" id="vencQtd">â€”</div>
          </div>
          <div>
            <div class="text-muted" style="font-size:.85rem">Valor mensal</div>
            <div class="fs-4 fw-semibold" id="vencValor">â€”</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Card Ãšltima importaÃ§Ã£o -->
<div class="row">
  <div class="col-md-4">
    <div id="card-ultima" class="card shadow-sm border-0 mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="card-title mb-0">Ãšltima importaÃ§Ã£o</h5>
          <span class="badge bg-info">MovimentaÃ§Ã£o</span>
        </div>
        <div id="ultima-content">
          <p class="text-muted mb-0">Carregandoâ€¦</p>
        </div>
      </div>
    </div>
  </div>
</div>

<hr>

<div class="row gy-4">
  <div class="col-md-6">
    <h5>ðŸ“ˆ Valor Mensal adicionado</h5>
    <div class="ratio ratio-16x9">
      <canvas id="graficoMesEnvio"></canvas>
    </div>
  </div>

  <div class="col-md-6">
    <h5>ðŸ§® Quantidade de Itens por Cliente (Top 10)</h5>
    <div class="ratio ratio-16x9">
      <canvas id="graficoPorCliente"></canvas>
    </div>
  </div>

  <div class="col-md-6">
    <h5>ðŸ’° Backlog por Cliente (Top 10)</h5>
    <div class="ratio ratio-16x9">
      <canvas id="graficoValorPorCliente"></canvas>
    </div>
  </div>

  <div class="col-md-6">
    <h5>ðŸ“… Valores Mensais a Vencer por Trimestre</h5>
    <div class="ratio ratio-16x9">
      <canvas id="graficoTrimestres"></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(function(){
  // Endpoints com fallback (mantidos)
  const ENDPOINTS = {
    DASH: ["/dashboard", "/api/dashboard", "/api/dashboard/"],
    CLIENTES: ["/dashboard/clientes", "/api/dashboard/clientes"],
    ULTIMA: ["/dashboard/ultima_importacao", "/api/ultima_importacao", "/ultima-importacao", "/ultima_importacao"]
  };

  const fmtMoney = new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL", maximumFractionDigits: 2 });
  const fmtInt = new Intl.NumberFormat("pt-BR");

  const elTotal = document.getElementById("totalContratos");
  const elTotalComItens = document.getElementById("totalContratosComItens");
  const elTotalItens = document.getElementById("totalItensContrato");
  const elMensal = document.getElementById("valorMensal");
  const elBacklog = document.getElementById("valorBacklog");
  const elResumo = document.getElementById("resumo");
  const chips = document.getElementById("chips-filtros");

  // KPIs adicionais
  const elRetQtd = document.getElementById("retMesQtd");
  const elRetVal = document.getElementById("retMesValor");
  const elEnvQtd = document.getElementById("envMesQtd");
  const elEnvVal = document.getElementById("envMesValor");
  const elVencQtd = document.getElementById("vencQtd");
  const elVencVal = document.getElementById("vencValor");

  const elUltima = document.getElementById("ultima-content");

  const fForm = document.getElementById("form-filtros");
  const fCliente = document.getElementById("f-cliente");
  const fDe = document.getElementById("f-de");
  const fAte = document.getElementById("f-ate");
  const sug = document.getElementById("sugestoes");

  let chMesEnvio, chQtdCliente, chValorCliente, chTrimestres;
  let timer;

  // Utils -------------------------------------------------
  async function fetchFirstOk(urls, opts) {
    for (const u of urls) {
      try {
        const r = await fetch(u, opts);
        if (r.ok) { return await r.json(); }
        console.warn("endpoint falhou:", u, r.status);
      } catch (e) { console.warn("erro em", u, e); }
    }
    throw new Error("Nenhum endpoint respondeu: " + urls.join(" | "));
  }
  function debounce(fn, ms){ return function(...a){ clearTimeout(timer); timer = setTimeout(()=>fn.apply(this,a), ms); } }
  function buildQuery(){
    const p = new URLSearchParams();
    if(fCliente.value.trim()) p.set("cliente", fCliente.value.trim());
    if(fDe.value) p.set("de", fDe.value);
    if(fAte.value) p.set("ate", fAte.value);
    return p.toString() ? ("?" + p.toString()) : "";
  }
  function renderChips(){
    chips.innerHTML = "";
    const list = [];
    if(fCliente.value.trim()) list.push("Cliente: " + fCliente.value.trim());
    if(fDe.value) list.push("De: " + fDe.value);
    if(fAte.value) list.push("AtÃ©: " + fAte.value);
    (list.length ? list : ["Sem filtros"]).forEach((t)=>{
      const span = document.createElement("span");
      span.className = "badge " + (list.length? "bg-dark":"bg-secondary");
      span.textContent = t;
      chips.append(span);
    });
  }
  function setKpis(total, comItens, itens, mensal, backlog){
    elTotal.textContent = total;
    elTotalComItens.textContent = comItens;
    elTotalItens.textContent = itens;
    elMensal.textContent = mensal;
    elBacklog.textContent = backlog;
  }
  function setExtras(retQtd, retVal, envQtd, envVal, vencQtd, vencVal){
    elRetQtd.textContent = retQtd;
    elRetVal.textContent = retVal;
    elEnvQtd.textContent = envQtd;
    elEnvVal.textContent = envVal;
    elVencQtd.textContent = vencQtd;
    elVencVal.textContent = vencVal;
  }
  function upsertChart(current, canvas, config){
    if(!canvas) return null;
    if(current){ current.data=config.data; current.options=config.options; current.update(); return current; }
    return new Chart(canvas.getContext("2d"), config);
  }

  // Autocomplete -----------------------------------------
  async function carregarSugestoes(){
    const q = fCliente.value.trim();
    const base = ENDPOINTS.CLIENTES[0];
    const url = q ? `${base}?q=${encodeURIComponent(q)}&limit=20` : `${base}?limit=20`;
    try{
      const resp = await fetch(url);
      if(!resp.ok) throw new Error("autocomplete falhou");
      const data = await resp.json();
      sug.innerHTML = "";
      (data.clientes || []).forEach(nome=>{
        const a = document.createElement("button");
        a.type = "button";
        a.className = "list-group-item list-group-item-action";
        a.textContent = nome || "N/D";
        a.onclick = ()=>{ fCliente.value = nome || ""; sug.style.display = "none"; fForm.requestSubmit(); };
        sug.appendChild(a);
      });
      sug.style.display = (data.clientes && data.clientes.length) ? "block" : "none";
    }catch{ sug.style.display = "none"; }
  }
  fCliente.addEventListener("focus", carregarSugestoes);
  fCliente.addEventListener("input", debounce(carregarSugestoes, 200));
  document.addEventListener("click", (e)=>{ if(!sug.contains(e.target) && e.target!==fCliente) sug.style.display="none"; });

  // Ãšltima importaÃ§Ã£o ------------------------------------
  function renderUltima(data){
    if(!data || data.exists === false){
      elUltima.innerHTML = "<p class='text-muted mb-0'>Nenhuma importaÃ§Ã£o registrada.</p>";
      return;
    }
    const ts = data.timestamp || "-";
    const ok = Number(data.ok || 0);
    const erros = Number(data.erros || 0);
    const lote = data.lote_id != null ? "#" + data.lote_id : "-";
    const contratos = Array.isArray(data.contratos_afetados) ? data.contratos_afetados : [];

    elUltima.innerHTML = `
      <div class="mb-2">
        <div class="text-muted" style="font-size:.9rem">Executada em</div>
        <div><strong>${ts}</strong></div>
      </div>
      <div class="d-flex gap-3 my-2">
        <div>
          <div class="text-muted" style="font-size:.8rem">OK</div>
          <div class="fs-4">${ok}</div>
        </div>
        <div>
          <div class="text-muted" style="font-size:.8rem">Erros</div>
          <div class="fs-4">${erros}</div>
        </div>
        <div>
          <div class="text-muted" style="font-size:.8rem">Lote</div>
          <div class="fs-4">${lote}</div>
        </div>
      </div>
      ${contratos.length ? `
        <div class="mt-2">
          <div class="text-muted" style="font-size:.9rem">Contratos afetados</div>
          <div class="d-flex flex-wrap gap-2 mt-1">
            ${contratos.map(cab => `<span class="badge bg-light text-dark border">#${cab}</span>`).join("")}
          </div>
        </div>
      ` : ""}
    `;
  }

  async function carregarUltima(){
    try {
      elUltima.innerHTML = "<p class='text-muted mb-0'>Carregandoâ€¦</p>";
      const data = await fetchFirstOk(ENDPOINTS.ULTIMA, { headers: { "Accept": "application/json" } });
      renderUltima(data);
    } catch (e) {
      elUltima.innerHTML = "<p class='text-danger mb-0'>NÃ£o foi possÃ­vel carregar a Ãºltima importaÃ§Ã£o.</p>";
      console.error(e);
    }
  }

  // Dashboard -------------------------------------------
  async function carregarDashboard() {
    try {
      elResumo.innerHTML = "";
      setKpis("...", "...", "...", "...", "...");
      setExtras("â€”","â€”","â€”","â€”","â€”","â€”");

      const qs = buildQuery();
      const urls = ENDPOINTS.DASH.map(u => u + qs);
      const d = await fetchFirstOk(urls, { headers: {"Accept":"application/json"} });

      setKpis(
        fmtInt.format(d.total_contratos ?? 0),
        fmtInt.format(d.total_contratos_com_itens ?? 0),
        fmtInt.format(d.total_itens_contrato ?? 0),
        fmtMoney.format(d.valor_mensal_total ?? 0),
        fmtMoney.format((d.backlog_total ?? d.valor_presente_total ?? 0))
      );

      setExtras(
        fmtInt.format(d.devolvidos_mes_atual?.quantidade ?? 0),
        fmtMoney.format(d.devolvidos_mes_atual?.valor_mensal ?? 0),
        fmtInt.format(d.entregues_mes_atual?.quantidade ?? 0),
        fmtMoney.format(d.entregues_mes_atual?.valor_mensal ?? 0),
        fmtInt.format(d.contratos_vencidos?.quantidade ?? 0),
        fmtMoney.format(d.contratos_vencidos?.valor_mensal ?? 0),
      );

      const porMesLabels = (d.mensal_por_mes ?? []).map(x => x.mes);
      const porMesData   = (d.mensal_por_mes ?? []).map(x => x.valor ?? 0);
      chMesEnvio = upsertChart(
        chMesEnvio, document.getElementById("graficoMesEnvio"),
        { type: "bar",
          data: { labels: porMesLabels, datasets: [{ label: "Valor mensal (R$)", data: porMesData }] },
          options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ ticks:{ callback:v=>fmtMoney.format(v) } } } } }
      );

      const qtdCliLabels = (d.qtd_por_cliente ?? []).map(x => x.cliente || "N/D");
      const qtdCliData   = (d.qtd_por_cliente ?? []).map(x => x.quantidade ?? 0);
      chQtdCliente = upsertChart(
        chQtdCliente, document.getElementById("graficoPorCliente"),
        { type: "bar",
          data: { labels: qtdCliLabels, datasets: [{ label: "Qtd. Itens", data: qtdCliData }] },
          options: { responsive:true, maintainAspectRatio:false, indexAxis: qtdCliLabels.length>10 ? "y" : "x" } }
      );

      const valRows = (d.backlog_por_cliente && d.backlog_por_cliente.length)
                      ? d.backlog_por_cliente
                      : (d.valor_presente_por_cliente || []);
      const valCliLabels = valRows.map(x => x.cliente || "N/D");
      const valCliData   = valRows.map(x => x.valor ?? 0);
      chValorCliente = upsertChart(
        chValorCliente, document.getElementById("graficoValorPorCliente"),
        { type: "bar",
          data: { labels: valCliLabels, datasets: [{ label: "Backlog (R$)", data: valCliData }] },
          options: { responsive:true, maintainAspectRatio:false,
                     indexAxis: valCliLabels.length>10 ? "y" : "x",
                     scales:{ y:{ ticks:{ callback:v=>fmtMoney.format(v) } } } } }
      );

      const triLabels = (d.vencimento_trimestres ?? []).map(x => x.bucket);
      const triData   = (d.vencimento_trimestres ?? []).map(x => x.valor ?? 0);
      chTrimestres = upsertChart(
        chTrimestres, document.getElementById("graficoTrimestres"),
        { type: "bar",
          data: { labels: triLabels, datasets: [{ label: "Valor mensal (R$)", data: triData }] },
          options: { responsive:true, maintainAspectRatio:false,
                     scales:{ y:{ ticks:{ callback:v=>fmtMoney.format(v) } } } } }
      );

      renderChips();
    } catch (err) {
      console.error(err);
      elResumo.innerHTML = "<p class='text-danger'>Erro ao carregar os dados do dashboard.</p>";
      setKpis("erro","erro","erro","erro","erro");
      setExtras("â€”","â€”","â€”","â€”","â€”","â€”");
    }
  }

  // Eventos
  document.getElementById("form-filtros").addEventListener("submit", function(e){ e.preventDefault(); carregarDashboard(); });
  document.addEventListener("DOMContentLoaded", ()=>{
    carregarDashboard();
    carregarUltima();
    renderChips();
  });
})();
</script>
{% endblock %}
